# API Endpoint Implementation Plan: Trip Generation Endpoint

## 1. Przegląd punktu końcowego
This endpoint is responsible for generating a detailed trip plan using an external AI service (e.g., Openrouter.ai). It processes the user's input—which includes trip parameters and optionally a set of note IDs—and returns a generated travel itinerary. The endpoint is secured via Supabase authentication and leverages validated data models and DTOs defined in the project.

## 2. Szczegóły żądania
- **HTTP Method**: POST
- **URL**: /trip/generate
- **Parametry**:
  - **Wymagane**:
    - `start_country` (string): The starting country for the trip.
    - `start_city` (string): The starting city for the trip.
    - `max_distance` (number): Maximum distance (in kilometers) for the trip.
  - **Opcjonalne**:
    - `selected_note_ids` (string[]): Array of note IDs to consider when generating the trip.
- **Request Body Schema**:
```json
{
  "start_country": "string",
  "start_city": "string",
  "max_distance": 100,
  "selected_note_ids": ["uuid1", "uuid2"]
}
```

## 3. Wykorzystywane typy
- **GenerateTripCommand**: Command model for the input payload (defined in `src/types.ts`).
- **TripPlanDTO**: DTO representing the response payload containing the generated trip plan.

## 4. Szczegóły odpowiedzi
- **Success (200 OK)**:
```json
{
  "status": "success",
  "data": {
    "plan": "Detailed travel itinerary generated by AI",
    "notes_used": ["uuid1", "uuid2"],
    "generated_at": "ISO timestamp"
  }
}
```
- **Error Responses**:
  - **400 Bad Request**: Invalid input (e.g., validation errors from Zod).
  - **401 Unauthorized**: Missing or invalid authentication token.
  - **429 Too Many Requests**: Rate limiting triggered by excessive requests to the AI service.
  - **500 Internal Server Error**: General server error.

## 5. Przepływ danych
1. The client sends a POST request with the specified payload.
2. Middleware authenticates the user using Supabase JWT stored in `context.locals`.
3. Input data is validated using a Zod schema against the `GenerateTripCommand` type.
4. The validated data is passed to the business logic layer (service), ideally implemented in `src/lib/services/tripGenerationService.ts`.
5. The service communicates with the external AI service to generate the trip plan based on the input.
6. On successful generation, the service returns a `TripPlanDTO` object which includes the generated plan, the notes used, and the generation timestamp.
7. The endpoint sends a JSON response with a status code of 200 and the generated data.
8. In the case of problem while calling AI, register error in the table `generation_error_logs`with appropriate datas (np. `error_code`, `error_msg`).

## 6. Względy bezpieczeństwa
- **Uwierzytelnianie**: Użycie Supabase Auth z JWT do weryfikacji użytkownika.
- **Autoryzacja**: Sprawdzenie, czy użytkownik ma dostęp do odpowiednich danych (RLS na poziomie bazy danych).

## 7. Obsługa błędów
- **400 Bad Request**: Zwracane, gdy dane wejściowe nie spełniają wymagań walidacyjnych (np. błędy Zod).
- **401 Unauthorized**: Zwracane, gdy użytkownik nie jest poprawnie autoryzowany.
- **429 Too Many Requests**: Zwracane w przypadku przekroczenia dozwolonej liczby żądań, szczególnie przy komunikacji z AI service.
- **500 Internal Server Error**: Zwracane w przypadku nieoczekiwanych błędów serwera. Wszystkie błędy powinny być odpowiednio logowane i, w miarę możliwości, rejestrowane w dedykowanej tabeli błędów.

## 8. Rozważania dotyczące wydajności
- **Timeout for calling AI**: 60 sec for waiting for response time, or timeout error.
- **Asynchroniczność**: Pomimo synchronicznej natury MVP, dla przyszłych iteracji warto rozważyć asynchroniczne przetwarzanie generowania tras.

## 9. Kroki implementacji
1. **Endpoint Creation**: Utworzyć plik endpointu w katalogu `/src/pages/api/` np. `generations.ts`.
2. **Authentication**: Dodanie mechanizmów uwierzytelniania poprzez Supabase Auth.
3. **Input Validation**: Zdefiniować Zod schema dla `GenerateTripCommand` w celu weryfikacji danych wejściowych.
4. **Service Layer**: Wyodrębnić logikę generowania trasy do dedykowanego serwisu, np. `src/lib/services/tripGenerationService.ts`, który będzie:
    - Integrował się z zewnętrznym AI service. Na etapie developmentu skorzystamy z mockow zamiast wywoływania serwisu AI.
    - Obsługiwał logikę zapisu do tabeli `generations` oraz rejestrował błędy w `generation_error_logs`.
5. **Endpoint logic** Implementacja logiki endpointu, wykorzystującej utworzony serwis.
6. **Actions and errors** Dodanie szczegółowego logowania akcji i błędów.
